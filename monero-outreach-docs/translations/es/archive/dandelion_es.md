# Dandelion++ para Monero

**“Dandelion++ detiene a los malintencionados enlazar la dirección IP a las transacciones de Monero.”**
_03/02/2020_

Monero se sostiene en su red de comunicación de persona a persona (P2P). La red de computadoras que soportan la cadena de bloques, llamados nodos, comparten la misma información que le da la potencia a Monero mismo, tal como las direcciones de los nodos, la información histórica de la cadena de bloques, la información de los bloques a medida que son minados y las nuevas transacciones que serán agregadas a estos mismos. Los nodos se identifican a través de las direcciones IP del protocolo de Internet, poniendo en riesgo a que observadores conecten las transacciones a través de las direcciones IP desanonimizando la información que contiene. Dandelion++, planeado para la integración en el software de Monero, es un método que oculta esta conexión. Este artículo describe como funciona Dandelion++ y que hará por los usuarios de Monero. 

### La red P2P de Monero

Monero tiene dos partes conceptuales: 1. una red P2P y 2. aplicaciones que corren en la red. Las aplicaciones, se ocupan de las direcciones, las claves y las transacciones, mientras que la red, organiza y asegura el flujo de información. Para entender Dandelion++ es importante considerar ambas, tanto la estructura de la red P2P y la manera como los monederos la utilizan para transmitir transacciones. 

Su estructura consta de miles de nodos alrededor del mundo, cientos de miles si incluyeramos los nodos pasivos, cada uno conectado usualmente a un pequeño grupo de otros nodos a través del Internet llamados peers [1]. Los nodos se comunican con sus peers usando el mismo protocolo de Control de Transmisión (TCP por sus siglas en inglés) usado por los navegadores y los servidores web. Los peers de los nodos aparecen de manera aleatoria y no necesitan estar geográficamente cerca unos de los otros. Un número común de peers, es ocho, pero otros tienen miles, con cada uno preguntandole a los nodos master sobre sus otros peers y así sucesivamente. El resultado es una red de muchas computadoras dispersas cada una comunicandose a través del protocolo TCP.

El monedero debe comunicarse con uno de estos nodos como puerto de enlace a la red P2P. Algunos monederos, como el GUI oficial, pueden ejecutar su propio nodo, mientras que otros como MyMonero, desde un celular, siempre usan un nodo remoto. Los monederos gastan Monero creando y transmitiendo una transacción a través del puerto de enlace del nodo, con el objetivo de que la transacción encontrará algún nodo de algún minero para incluirse en el bloque a minar. Cada transacción contiene información que es limitada pero valiosa, incluyendo el conjunto de posibles vínculos de los fondos gastados. 

Hasta el momento, el nodo de Monero que inicia la transmisión de una nueva transacción usa el proceso llamado desbordamiento, inundación o flooding en inglés. Comunica la transacción a todos su peers, que a su vez la comunican con todos los demás peers, haciendo algunas revisiones para prevenir la redundancia en la comunicación, y así sucesivamente. La información viaja a través de la red como una ola en todas las direcciones. Algunas criptomonedas como Bitcoin aleatorizan los tiempos de transmisión, pero Monero, no.

### El problema

Tu dirección IP puede decir mucho de ti. (Para tener un ejemplo de que se sabe de tu dirección IP, visita un sitio web que de información de la IP, como por ejemplo [whatismyipaddress.com](https://whatismyipaddress.com/).) Con la información de tu Prestador de Servicio de Internet o la información del proveedor de la Red Privada Virtual (ISP/VPN por sus siglas en inglés), dependiendo del caso, te podrían identificar por nombre propio. Cualquier conexión entre la transacción que crees y tu dirección IP deja información al descubierto, incluso, el solo hecho de hacer una transacción de Monero es algo que ni siquiera quisieramos que un extraño supiera. El problema es que el desbordamiento de transacciones por la red P2P de Monero le permite a otros hacer la conexión entre la transacción y la dirección IP [2].

Conectar una dirección IP a una transacción no es fácil ni tampoco perfecta. Toma muchos observadores y mucho trabajo. Pero, por ejemplo, utilizando un botnet conectado a la red P2P de Monero, te permitiría hacer calculos del posible origen de una transacción usando el análisis de tiempo y comparandolo con información conocida de los peers. Cuando escuchas un sonido muy alto sabes hacia donde mirar porque tu cerebro extrae la dirección de los tiempos y la distorción del sonido en cada oído. El análisis de paquetes recibidos, le permite a un adversario espiar a través del desbordamiento de información de diferentes ubicaciones. La creación de transacciones es como un ruido muy alto para los nodos botnet que funcionan como oídos.

### Dandelion

Para abordar este problema, investigadores dedicados en la Universidad de Illinois, desarrollaron una serie de técnicas que llaman Dandelion [2]. El primer enfoque fue para Bitcoin, pero también aplica para Monero. La idea de Dandelion es enrutar las transacciones a un nodo remoto de una manera indetectable antes de iniciar el desbordamiento de información. 

Los autores de Dandelion profundizaron en la teoría y práctica usando botnets para encontrar los orígenes de las transacciones de las criptomonedas. Esto incluyo la creación de modelos matemáticos para el anonimato (revisa el punto [2] para información detallada) que fueron usados para analizar tres técnicas de propagación: 1. desbordamiento básico (el método de Monero), 2. el desbordamiento aleatorio llamado difusión (el método de Bitcoin) y 3. la difusión por proxy. El último método primero dirige la transacción hacia un nodo aleatorio, quien despues la transmite usando la difusión. Las tres técnicas se encontraron como inadecuadas utilizando el modelo matemático de los autores. 

Para abordar este inconveniente, los autores propusieron Dandelion. Dandelion define el proceso encontrando un nodo proxy para transmitir, llamado la fase anónima o tallo (stem en inglés). Y, establece otro proceso para la transmisión llamado la fase de propagación o cipsela (fluff en inglés). En general las dos fases usan una serie de conexiones entre peers diferentes con la diferencia que el conjunto de conexiones de la fase anónima cambia en el tiempo. El nombre descriptivo de dandelion o diente de león viene del proceso inicial de encontrar un nodo proxy a través de una busqueda linear especial, que luego, desde este nodo, se propaga la información de manera rápida y simétrica, asimilando el flujo de informacion a la imagen de un diente de león.

Dandelion, analizado bajo el modelo matemático del autor, cuando es utilizado por todos los nodos, prueba ser resistente al espionaje de un grupo de nodos siendo observadores pasivos. Con Dandelion, un botnet participando de manera honesta en la red P2P, no puede, de manera segura, conectar las transacciones con las direcciones IP.

### Dandelion++

Sin embargo, un adversario intentando enlazar transacciones con las direcciones IP podría no hacerlo de manera pasiva y podría no seguir las reglas dentro de la red. Algunos nodos honestos puede que no ejecuten Dandelion. Motivados por el creciente y extenso mercado del criptoanálisis hacia las criptomonedas, tal como lo hace Chainalysis [4], los autores revisaron las suposiciones en las que basaron su trabajo anterior y, con colaboradores, un año despues, desarrollaron Dandelio++ [3]. Dandelion++ ajusta Dandelion para resistir ataques de desanonimización a gran escala que rompen las reglas de la red.

Los creadores de Dandelion++ crearon un botnet adversario con nodos espía distribuidos por toda la red, formando una fracción significante de esta. En su modelo, los nodos no necesitan seguir las reglas. Pueden generar cualquier cantidad de conexiones a cualquier nodo honesto o adversario. Usan toda la información disponible, incluyendo los tiempos y las direcciones de quienes envían. Es en este entorno tan hostil, donde Dandelion++ tiene exito protegiendo el anonimato.

Dandelion++, tal como Dandelion, tiene las fases de tallo y cipsela. En la nueva fase de tallo, para implementar la conectividad dinámica, procede en intervalos discretos llamados epochs o períodos. Cada ciertos minutos, de manera independiente, los nodos cambian de periodo. Con cada nuevo período, el nodo de manera aleatoria selecciona dos nuevas conexiones retransmisoras desde su conexión de salida. Luego, cuando el nodo crea su propia transacción la enviará a través de alguna de estas dos conexiones, haciendo lo mismo en cada período. Y cuando el nodo recibe una transacción de otro nodo envíada durante la fase de tallo, si es una retransimisión (más abajo lo explicaremos), la envía aleatoriamente por alguna de las dos retransmisiones. 

La fase cipsela en Dandelion++ utiliza la difusión, la difusión es el proceso de desbordamiento donde los tiempos de comunicación son aleatorios para dificultarle a los nodos espías encontrar el origen de envío. Una vez la transacción ha comenzado el proceso de difusión, continua la propagación usando la difusión sin devolverse a la fase de tallo. Sin embargo, en Dandelion++, la difusión comienza de una manera especial. Durante cada período, el nodo se clasifica a si mismo como retransmisor o difusor. El modo es determinado aleatoriamente al inicio de cada período. Si el nodo es un difusor en el momento que se le da una transacción para retransmitir como fase de tallo, en vez de transmitirla, inicia como cipsela transmitiendo la transacción usando la difusión.

Hay una pieza adicional complementaria en Dandelion++, llamada el mecanismo de prueba de errores. Cada nodo que retransmite una transacción durante la fase de tallo, inicia un temporizador para cada transacción. Si en un lapso de tiempo el nodo no recibe la misma transacción devuelta, este comienza su propia fase cipsela. Esto sirve dos propósitos: frusta los intentos de desanonimización de la información usando intervalos de tiempos e impide los llamados ataques black-hole donde nodos controlados por un adversario descartan transacciones en la fase de tallo en vez de retransmitirlas. 

Con estás técnicas en marcha, Dandelion++ da garantías formales de resistencia a una desanonimización de la red. Esto lo logra con técnicas locales, a diferencia de la red de Tor que necesita un razonamiento global. Cada nodo de Dandelion++ toma sus propias decisiones sobre su comportamiento. El resultado es una técnica rápida y eficiente, pero efectiva, para prevenir que adversarios sofisticados conecten las direcciones IP con las transacciones.

### Integración con Monero

Aunque Dandelion++ fue desarrollado expresamente para Bitcoin, recientemente ha sido adherido a Monero por el desarrollador Lee Clagett (vtnerd), revisado y testeado por el desarrollador moneromooo. Las discusiones y los cambios en los archivos hechos por estos destacados desarrolladores pueden verse en el pull request [5]. Un "pull request" es una parte formal del proceso donde código recien agregado ingresa al código principal. Aunque el pull request de Dandelion++ ya fue aprovado por moneromooo, al momento de escribir este artículo, aún no ha sido completamente revisado ni fusionado (merged) al código principal de Monero.

Cuando Dandelion++ sea lanzado, será usado de manera predeterminada, sin embargo, es posible desactivarlo modificando el archivo cryptonote_config.h de código C++, defininiendo la probabilidad del ingreso en el modo cipsela a 100%, y recompilando el código. De manera importante, incluso en este caso de la recompilación dirigida, la nueva versión usará la difusión con sus retransmisiones aleatorias en vez del desbordamiento. La fecha del lanzamiento formal aún no esta dado. La incorporación de Dandelion++ no requiere de un hard fork.  

Existen pequeñas desventajas y limitaciones. Dandelion++ añade retrasos en la propagación de las transacciones. Esto tiene múltiples causas, que son discutidas por los mismos autores [3]. Primero, la existencia de la fase de tallo causa posiblemente retrasos de algunos segundos, basados en análisis y experimentaciones evaluadas por los mismos autores. La difusión, normalmente añade retrasos aleatorios de menos de un segundo durante la fase de cipsela. Si la red llega a estar sometida a un ataque black-hole, la confirmación de espera por el iniciador podría causar retrazos por algunos minutos en la transmisión. No se esperan que estos retrazos afecten la red. Además, Dandelion++ no encripta los paquetes P2P y no protege en contra del espionaje a nivel de ISP/VPN (Proveedor de servicio de Internet/Red Privada Virtual). Para esto utiliza Tor.

[1] Exploring the Monero Peer-to-Peer Network, T. Cao, J. Yu, J. Decouchant, X Luo, and P. Verissimo, [eprint.iacr.org/2019/411.pdf](https://eprint.iacr.org/2019/411.pdf).  
[2] Dandelion: Redesigning the Bitcoin Network for Anonymity, S.B. Venkatakrishan, G. Fanti, and P. Viswanath, SIGMETRICS ’17, June 5-9, 2017, Urbana-Champaign, [publish.illinois.edu/science-of-security-lablet/files/2016/07/Dandelion-Redesigning-BitCoin-Networking-for-Anonymity.pdf](http://publish.illinois.edu/science-of-security-lablet/files/2016/07/Dandelion-Redesigning-BitCoin-Networking-for-Anonymity.pdf)  
[3] Dandelion++: Lightweight Cryptocurrency Networking with Formal Anonymity Guarantees, G. Fanti, S.B. Venkatakrishnan, S. Bakshi, B. Denby, S. Bhargava, A. Miller, and P. Viswanath, arXiv:1805.11060v1, May 28, 2018, [arxiv.org/pdf/1805.11060.pdf](https://arxiv.org/pdf/1805.11060.pdf)  
[4] Chainalysis, [chainalysis.com](https://www.chainalysis.com/).
[5] Adding Dandelion++ support to public networks: #6314, [github.com/monero-project/monero/pull/6314](https://github.com/monero-project/monero/pull/6314).  

### Resumen

Un poderoso método para prevenir la desanonimización en Monero está por venir, Dandelion++. Este método desarrollado originalmente para Bitcoin y aplicado a Monero por el desarrollador Lee Clagett, previene que adversarios conecten las direcciones IP a las transacciones de Monero, incluso en ataques sofisticados a gran escala. Se enfoca particularmente en la resistencia a botnets. Dandelion++ usa las fases de tallo y cipsela haciendo que la información tome forma de diente de león o dandelion en inglés, y por eso su nombre. Esta nueva característica mejorará las ya existentes características de privacidad de Monero y llevar a Monero en un camino de progreso continuo. 

### _Aprende más_

- Lee Clagett en Monero Konferenco: [Dandelion Onions: Protecting Transaction Privacy in Monero](https://www.monerooutreach.org/monero-konferenco/lee-clagett.html)